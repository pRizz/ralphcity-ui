# Codebase Structure

**Analysis Date:** 2026-01-17

## Directory Layout

```
gascountry-ui/
├── backend/                    # Rust backend server
│   ├── src/
│   │   ├── api/               # HTTP route handlers
│   │   ├── db/                # Database layer
│   │   ├── git/               # Git operations
│   │   ├── ralph/             # External process manager
│   │   ├── service/           # System service management
│   │   ├── ws/                # WebSocket handling
│   │   ├── assets.rs          # Embedded frontend serving
│   │   ├── error.rs           # Error types
│   │   └── main.rs            # Entry point and CLI
│   └── Cargo.toml             # Backend dependencies
├── frontend/                   # React/TypeScript frontend
│   ├── src/
│   │   ├── api/               # API client and hooks
│   │   ├── components/        # React components
│   │   │   ├── ui/            # shadcn/ui primitives
│   │   │   └── ralphtown/     # Feature components
│   │   ├── hooks/             # Custom React hooks
│   │   ├── lib/               # Utilities
│   │   ├── pages/             # Route components
│   │   ├── test/              # Test setup
│   │   ├── types/             # TypeScript types
│   │   ├── data/              # Mock/static data
│   │   ├── App.tsx            # Root component
│   │   └── main.tsx           # Entry point
│   ├── public/                # Static assets
│   ├── dist/                  # Build output (embedded in backend)
│   └── package.json           # Frontend dependencies
├── Cargo.toml                 # Workspace manifest
├── Cargo.lock                 # Rust lockfile
└── README.md                  # Project documentation
```

## Directory Purposes

**`backend/src/api/`:**
- Purpose: HTTP and REST API handlers
- Contains: Route definitions, request/response types, shared AppState
- Key files:
  - `mod.rs`: AppState definition, module exports
  - `repos.rs`: Repository CRUD endpoints
  - `sessions.rs`: Session management and ralph execution
  - `git.rs`: Git operations (status, log, branches, diff, commit)
  - `config.rs`: Configuration key-value store
  - `service.rs`: Service management API

**`backend/src/db/`:**
- Purpose: SQLite database abstraction
- Contains: Schema, models, CRUD operations
- Key files:
  - `mod.rs`: Database struct with all operations
  - `schema.rs`: SQL table definitions, migrations
  - `models.rs`: Rust structs for data entities

**`backend/src/ws/`:**
- Purpose: WebSocket server for real-time updates
- Contains: Connection management, message types, protocol handling
- Key files:
  - `mod.rs`: WebSocket upgrade handler, message routing
  - `connections.rs`: Pub/sub connection manager
  - `messages.rs`: Client/Server message enums

**`backend/src/ralph/`:**
- Purpose: Manage external `ralph` CLI process lifecycle
- Contains: Process spawning, output streaming, cancellation
- Key files:
  - `mod.rs`: RalphManager with run/cancel/status methods

**`backend/src/service/`:**
- Purpose: Install/manage as system service
- Contains: Platform-specific service management (launchd, systemd, Windows)
- Key files:
  - `mod.rs`: ServiceController with install/uninstall/start/stop/status

**`frontend/src/api/`:**
- Purpose: Backend communication layer
- Contains: Fetch wrappers, React Query hooks, TypeScript types
- Key files:
  - `client.ts`: Fetch-based API functions
  - `hooks.ts`: React Query hooks for all endpoints
  - `types.ts`: API request/response TypeScript interfaces
  - `index.ts`: Re-exports

**`frontend/src/components/ui/`:**
- Purpose: shadcn/ui primitive components
- Contains: Reusable UI building blocks (Button, Input, Dialog, etc.)
- Key files: `button.tsx`, `input.tsx`, `dialog.tsx`, `card.tsx`, etc.
- Note: Generated by shadcn CLI, avoid manual edits

**`frontend/src/components/ralphtown/`:**
- Purpose: Application-specific feature components
- Contains: Main UI components for the Ralphtown app
- Key files:
  - `MainPanel.tsx`: Main content area with session/prompt UI
  - `AgentSidebar.tsx`: Session list sidebar
  - `ConversationView.tsx`: Session output display
  - `PromptInput.tsx`: User prompt input component
  - `RepoSelector.tsx`: Repository/branch selection
  - `SettingsDialog.tsx`: Configuration dialog
  - `AgentListItem.tsx`: Individual session list item

**`frontend/src/hooks/`:**
- Purpose: Custom React hooks for shared logic
- Contains: WebSocket management, utility hooks
- Key files:
  - `useWebSocket.ts`: WebSocket connection with auto-reconnect
  - `use-toast.ts`: Toast notification hook

**`frontend/src/pages/`:**
- Purpose: Top-level route components
- Contains: One component per route
- Key files:
  - `Index.tsx`: Main application page
  - `NotFound.tsx`: 404 fallback page

**`frontend/src/types/`:**
- Purpose: Application-specific TypeScript types
- Contains: UI types, adapter functions
- Key files:
  - `ralphtown.ts`: UI types and API-to-UI adapters

## Key File Locations

**Entry Points:**
- `backend/src/main.rs`: Backend binary entry, CLI parsing, server startup
- `frontend/src/main.tsx`: React DOM mounting
- `frontend/src/App.tsx`: React root component with providers and router

**Configuration:**
- `backend/Cargo.toml`: Rust dependencies and build config
- `frontend/package.json`: Node dependencies and scripts
- `frontend/vite.config.ts`: Vite bundler configuration
- `frontend/tailwind.config.ts`: Tailwind CSS configuration
- `frontend/tsconfig.json`: TypeScript compiler options

**Core Logic:**
- `backend/src/ralph/mod.rs`: Process spawning and management
- `backend/src/db/mod.rs`: Database operations
- `backend/src/ws/mod.rs`: WebSocket handling
- `frontend/src/api/hooks.ts`: React Query data fetching
- `frontend/src/hooks/useWebSocket.ts`: Real-time communication

**Testing:**
- `backend/src/**/*.rs` (inline): Rust unit tests in `#[cfg(test)]` modules
- `frontend/src/test/setup.ts`: Vitest test setup
- `frontend/src/test/example.test.ts`: Example test file

## Naming Conventions

**Files:**
- Rust modules: `snake_case.rs` (e.g., `mod.rs`, `repos.rs`, `sessions.rs`)
- React components: `PascalCase.tsx` (e.g., `MainPanel.tsx`, `AgentSidebar.tsx`)
- TypeScript modules: `camelCase.ts` (e.g., `client.ts`, `hooks.ts`, `types.ts`)
- shadcn components: `kebab-case.tsx` (e.g., `button.tsx`, `alert-dialog.tsx`)

**Directories:**
- Rust: `snake_case` (e.g., `src/api/`, `src/db/`)
- TypeScript: `kebab-case` or `camelCase` (e.g., `components/ui/`, `components/ralphtown/`)

**Exports:**
- Rust: Re-export from `mod.rs` for public API
- TypeScript: Barrel exports via `index.ts` where present

## Where to Add New Code

**New Backend API Endpoint:**
1. Create handler function in appropriate `backend/src/api/*.rs` file
2. Add route in the file's `router()` function
3. If new resource, create new file (e.g., `backend/src/api/newresource.rs`)
4. Add to module exports in `backend/src/api/mod.rs`
5. Nest router in `backend/src/main.rs` `create_app()`

**New Frontend Page:**
1. Create component in `frontend/src/pages/NewPage.tsx`
2. Add route in `frontend/src/App.tsx` Routes section
3. Use existing API hooks or create new ones in `frontend/src/api/hooks.ts`

**New Feature Component:**
1. Create in `frontend/src/components/ralphtown/NewComponent.tsx`
2. Use shadcn primitives from `frontend/src/components/ui/`
3. Import in parent component (likely `MainPanel.tsx` or new page)

**New UI Primitive:**
1. Use shadcn CLI: `npx shadcn@latest add <component>`
2. Component appears in `frontend/src/components/ui/`

**New API Endpoint Types (Frontend):**
1. Add request/response types to `frontend/src/api/types.ts`
2. Add client function to `frontend/src/api/client.ts`
3. Add React Query hook to `frontend/src/api/hooks.ts`

**New Database Table:**
1. Add schema SQL to `backend/src/db/schema.rs`
2. Increment `SCHEMA_VERSION`
3. Add model struct to `backend/src/db/models.rs`
4. Add CRUD methods to `backend/src/db/mod.rs`

**New Custom Hook:**
1. Create in `frontend/src/hooks/useNewHook.ts`
2. Follow pattern of existing hooks (refs for callbacks, cleanup in useEffect)

## Special Directories

**`frontend/dist/`:**
- Purpose: Vite build output, embedded into backend binary
- Generated: Yes (by `npm run build`)
- Committed: Yes (needed for `cargo install` to work without Node)

**`target/`:**
- Purpose: Rust build artifacts
- Generated: Yes (by cargo)
- Committed: No

**`node_modules/`:**
- Purpose: npm dependencies
- Generated: Yes (by `npm install`)
- Committed: No

**`.planning/`:**
- Purpose: GSD planning documents and codebase analysis
- Generated: No (manual/agent-created)
- Committed: Yes

**`.agent/`:**
- Purpose: Agent configuration or state
- Generated: Varies
- Committed: Check `.gitignore`

**`.sop/`:**
- Purpose: Standard operating procedures
- Generated: No (documentation)
- Committed: Yes

---

*Structure analysis: 2026-01-17*
