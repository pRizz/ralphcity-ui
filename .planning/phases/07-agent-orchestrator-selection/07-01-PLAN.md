---
phase: 07-agent-orchestrator-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/db/schema.rs
  - backend/src/db/models.rs
  - backend/src/db/mod.rs
  - backend/src/api/sessions.rs
autonomous: true

must_haves:
  truths:
    - "Sessions table has orchestrator column"
    - "Existing sessions default to ralph orchestrator"
    - "Backend validates orchestrator is available before creating session"
    - "Session response includes orchestrator field"
  artifacts:
    - path: "backend/src/db/models.rs"
      provides: "Orchestrator enum with Ralph, Gsd, Gastown variants"
      contains: "pub enum Orchestrator"
    - path: "backend/src/db/schema.rs"
      provides: "Schema migration v1 to v2"
      contains: "SCHEMA_VERSION: i32 = 2"
    - path: "backend/src/db/mod.rs"
      provides: "insert_session with orchestrator parameter"
      contains: "orchestrator: Orchestrator"
    - path: "backend/src/api/sessions.rs"
      provides: "CreateSessionRequest with orchestrator field"
      contains: "orchestrator"
  key_links:
    - from: "backend/src/api/sessions.rs"
      to: "backend/src/db/mod.rs"
      via: "insert_session call with orchestrator"
      pattern: "insert_session.*orchestrator"
    - from: "backend/src/db/mod.rs"
      to: "backend/src/db/schema.rs"
      via: "migration application"
      pattern: "MIGRATE_V1_TO_V2"
---

<objective>
Add orchestrator support to the backend database and API layer.

Purpose: Enable per-session orchestrator selection by extending the database schema, adding an Orchestrator enum, and updating the session creation/retrieval APIs to include orchestrator.

Output: Backend that stores and returns orchestrator per session, with schema migration for existing databases.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-agent-orchestrator-selection/07-RESEARCH.md

# Existing patterns
@backend/src/db/models.rs - SessionStatus enum pattern to follow
@backend/src/db/schema.rs - Current schema, SCHEMA_VERSION pattern
@backend/src/db/mod.rs - insert_session signature to update
@backend/src/api/sessions.rs - CreateSessionRequest to update
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Orchestrator enum and update Session model</name>
  <files>backend/src/db/models.rs</files>
  <action>
Add a new Orchestrator enum following the SessionStatus pattern:

1. Define `Orchestrator` enum with variants: Ralph, Gsd, Gastown
2. Add `#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]`
3. Add `#[serde(rename_all = "lowercase")]` for JSON serialization
4. Implement `as_str()` method returning lowercase strings ("ralph", "gsd", "gastown")
5. Implement `from_str()` method parsing strings to enum
6. Implement `is_available()` method - returns true only for Ralph
7. Implement `Default` trait - defaults to Ralph

Update the `Session` struct to add `orchestrator: Orchestrator` field after `name`.

Follow the exact pattern used for SessionStatus enum - it's on lines 16-47 of the file.
  </action>
  <verify>
`cargo check -p backend` passes with no errors
  </verify>
  <done>
Orchestrator enum exists with all variants. Session struct has orchestrator field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add schema migration and update database operations</name>
  <files>backend/src/db/schema.rs, backend/src/db/mod.rs</files>
  <action>
In schema.rs:
1. Increment `SCHEMA_VERSION` from 1 to 2
2. Add migration constant:
```rust
pub const MIGRATE_V1_TO_V2: &str = r#"
ALTER TABLE sessions ADD COLUMN orchestrator TEXT NOT NULL DEFAULT 'ralph';
"#;
```

In mod.rs:

1. Add `Orchestrator` to the imports from models
2. Update `init_schema()` to run migration:
   - After checking current_version, if version is 1, execute MIGRATE_V1_TO_V2
   - Add import for `MIGRATE_V1_TO_V2` in the use statement
3. Update `insert_session()` signature to accept `orchestrator: Orchestrator` parameter
4. Update the INSERT statement to include orchestrator column
5. Update the Session construction to include orchestrator field
6. Update `get_session()` to read orchestrator column (index 4, shift others)
7. Update `list_sessions()` to read orchestrator column
8. Update `list_sessions_by_repo()` to read orchestrator column

For reading orchestrator from DB, use the existing `parse_enum()` helper with `Orchestrator::from_str`.

Column order in sessions queries should be: id, repo_id, name, orchestrator, status, created_at, updated_at
  </action>
  <verify>
`cargo test -p backend` passes - existing tests should still work since orchestrator defaults to ralph
  </verify>
  <done>
Schema version is 2. Migration adds orchestrator column. All session operations include orchestrator.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update API to accept and validate orchestrator</name>
  <files>backend/src/api/sessions.rs</files>
  <action>
1. Add import for `Orchestrator` from db::models
2. Update `CreateSessionRequest` to include orchestrator field:
   ```rust
   #[serde(default)]
   pub orchestrator: Orchestrator,
   ```
   The `#[serde(default)]` makes it optional, defaulting to Ralph.

3. In `create_session()` handler:
   - Add validation: if `!req.orchestrator.is_available()`, return BadRequest error:
     "Orchestrator '{}' is not yet available"
   - Pass orchestrator to `insert_session()` call

4. Update tests that create sessions to pass orchestrator to insert_session calls.
   For most tests, can use `Orchestrator::Ralph` or rely on the default.
   Update the tests in `test_create_and_list_session` and similar to check that
   session response includes orchestrator field.
  </action>
  <verify>
`cargo test -p backend` passes. All session tests pass including new orchestrator validation.
  </verify>
  <done>
CreateSessionRequest accepts optional orchestrator. Backend validates orchestrator availability. Session responses include orchestrator.
  </done>
</task>

</tasks>

<verification>
1. `cargo build -p backend` completes successfully
2. `cargo test -p backend` passes all tests
3. Manual test: Start backend, create session with curl, verify orchestrator in response:
   ```bash
   curl -X POST http://localhost:8080/sessions \
     -H "Content-Type: application/json" \
     -d '{"repo_id": "...", "orchestrator": "ralph"}'
   ```
4. Verify creating session with "gsd" orchestrator returns 400 Bad Request
</verification>

<success_criteria>
- Sessions table has orchestrator column with default 'ralph'
- Orchestrator enum has Ralph (available), Gsd (unavailable), Gastown (unavailable)
- Session creation validates orchestrator is available
- Session responses include orchestrator field
- All existing tests pass (backwards compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/07-agent-orchestrator-selection/07-01-SUMMARY.md`
</output>
